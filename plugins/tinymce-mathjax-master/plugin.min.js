tinymce.PluginManager.add("mathjax",function(t,e){let n=t.getParam("mathjax"),a=n.className||"math-tex",l=a+"-original",i=n.symbols||{start:"\\(",end:"\\)"},o=n.lib||null,r=n.configUrl||e+"/config.js";n.className&&(r+="?class="+n.className);let s=[r];o&&s.push(o),t.on("init",function(){let e=t.getDoc().getElementsByTagName("script");for(let n=0;n<s.length;n++){let a=t.dom.uniqueId(),l=t.dom.create("script",{id:a,type:"text/javascript",src:s[n]}),i=!1;for(let o=0;o<e.length;o++)if(e[o].src==l.src||e[o].src==s[n]){i=!0;break}i||t.getDoc().getElementsByTagName("head")[0].appendChild(l)}}),t.on("GetContent",function(e){let n=t.dom.create("div");n.innerHTML=e.content;let l=n.querySelectorAll("."+a);for(let i=0;i<l.length;i++){let o=l[i].querySelectorAll("span");for(let r=0;r<o.length;r++)o[r].remove();let s=l[i].getAttribute("data-latex");l[i].removeAttribute("contenteditable"),l[i].removeAttribute("style"),l[i].removeAttribute("data-latex"),l[i].innerHTML=s}e.content=n.innerHTML});let c=function(e){if(2!=e.childNodes.length){e.setAttribute("contenteditable",!1),e.style.cursor="pointer";let n=e.getAttribute("data-latex")||e.innerHTML;e.setAttribute("data-latex",n),e.innerHTML="";let a=t.dom.create("span");a.innerHTML=n,a.classList.add(l),e.appendChild(a);let i=t.dom.create("span");i.classList.add("dummy"),i.innerHTML="dummy",i.setAttribute("hidden","hidden"),e.appendChild(i)}};t.on("BeforeSetContent",function(e){let n=t.dom.create("div");n.innerHTML=e.content;let l=n.querySelectorAll("."+a);for(let i=0;i<l.length;i++)c(l[i]);e.content=n.innerHTML}),t.on("SetContent",function(e){t.getDoc().defaultView.MathJax&&t.getDoc().defaultView.MathJax.typesetPromise()}),t.on("Change",function(e){if((elements=t.dom.getRoot().querySelectorAll("."+a)).length){for(let n=0;n<elements.length;n++)c(elements[n]);t.getDoc().defaultView.MathJax&&t.getDoc().defaultView.MathJax.typesetPromise()}}),t.ui.registry.addToggleButton("mathjax",{text:"Equation",tooltip:"Mathjax",onAction:function(){let e=t.selection.getNode(),n;e.classList.contains(a)&&(n=e),d(n)},onSetup:function(e){return t.selection.selectorChangedWithUnbind("."+a,e.setActive).unbind}}),t.on("click",function(t){let e=t.target.closest("."+a);e&&d(e)});let d=function(e){let n=t.id+"_"+t.dom.uniqueId(),o="";e&&(latex_attribute=e.getAttribute("data-latex")).length>=(i.start+i.end).length&&(o=latex_attribute.substr(i.start.length,latex_attribute.length-(i.start+i.end).length)),t.windowManager.open({title:"Insert LaTex",width:600,height:300,body:{type:"panel",items:[{type:"textarea",name:"title",label:"LaTex"},{type:"htmlpanel",html:'<div style="text-align:right"><a href="https://wikibooks.org/wiki/LaTeX/Mathematics" target="_blank" style="font-size:small">LaTex</a></div>'},{type:"htmlpanel",html:'<iframe id="'+n+'" style="width: 100%; min-height: 50px;"></iframe>'}]},buttons:[{type:"submit",text:"OK"}],onSubmit:function n(l){let i=l.getData().title.trim();if(e)e.innerHTML="",e.setAttribute("data-latex",h(i)),c(e);else{let o=t.getDoc().createElement("span");o.innerHTML=h(i),o.classList.add(a),c(o),t.insertContent(o.outerHTML)}t.getDoc().defaultView.MathJax.typesetPromise(),l.close()},onChange:function(t){var e=t.getData().title.trim();e!=o&&(p(e,document.getElementById(n)),o=e)},initialData:{title:o}});let r=document.getElementById(n),d=r.contentWindow||r.contentDocument.document||r.contentDocument,m=d.document,u=m.getElementsByTagName("head")[0],g=m.getElementsByTagName("body")[0],h=function(t,e){return e||(e=i),e.start+" "+t+" "+e.end},p=function(t){let e=d.MathJax,n=g.querySelector("div");n||((n=m.createElement("div")).classList.add(l),g.appendChild(n)),n.innerHTML=h(t,{start:"$$",end:"$$"}),e&&e.typesetPromise()};p(o);for(let f=0;f<s.length;f++){let y=d.document.createElement("script");y.src=s[f],y.type="text/javascript",y.async=!1,y.charset="utf-8",u.appendChild(y)}}});